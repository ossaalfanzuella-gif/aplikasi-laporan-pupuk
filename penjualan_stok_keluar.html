<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Stok Pupuk - Stok Keluar</title>
    
    <!-- Memuat Tailwind CSS untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Import Firebase SDK (Modul) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc,
            serverTimestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP & VARIABLES ---
        
        // Ensure global canvas variables are available
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUserId = null;
        
        // Firestore path: Using Public path for shared data
        // /artifacts/{appId}/public/data/fertilizer_stock
        const getCollectionPath = (appId) => `/artifacts/${appId}/public/data/fertilizer_stock`;

        // --- AUTHENTICATION AND INITIALIZATION ---
        
        async function initApp() {
            if (!firebaseConfig) {
                console.error("Firebase config is not available.");
                showMessage('Error: Konfigurasi Firebase tidak ditemukan.', 'bg-red-100 border-red-400 text-red-700');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set debug level
                setLogLevel('Debug');
                
                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID Pengguna Aktif: ${currentUserId}`;
                        console.log("User authenticated. UID:", currentUserId);
                    } else {
                        currentUserId = crypto.randomUUID(); // Temporary anonymous ID
                        document.getElementById('userIdDisplay').textContent = `ID Pengguna Anonim: ${currentUserId}`;
                        console.error("Authentication failed, using temporary anonymous ID.");
                    }
                });
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessage('Error Inisialisasi. Cek console log.', 'bg-red-100 border-red-400 text-red-700');
            }
        }
        
        /**
         * Shows a temporary message in the dedicated message box area.
         * @param {string} message - The message text.
         * @param {string} classes - Tailwind classes for styling (e.g., 'bg-green-100 border-green-400 text-green-700').
         */
        function showMessage(message, classes) {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = message;
            msgBox.className = `p-3 rounded-lg border text-sm transition-all duration-300 ${classes}`;
            msgBox.classList.remove('opacity-0', 'scale-95');
            
            setTimeout(() => {
                msgBox.classList.add('opacity-0', 'scale-95');
            }, 5000);
        }

        // --- HANDLER FUNCTIONS ---
        
        /**
         * Handles the form submission for recording a stock reduction (sale).
         * Note: Stock reduction is achieved by saving a negative quantity value.
         */
        async function handleStockOut(event) {
            event.preventDefault();
            
            const form = event.target;
            const name = form.elements['fertilizerName'].value.trim();
            const quantity = parseFloat(form.elements['quantityOut'].value);
            const type = form.elements['fertilizerType'].value.trim();
            const transactionDate = form.elements['transactionDate'].value;
            
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = 'Memproses...';

            if (!name || isNaN(quantity) || quantity <= 0 || !type || !transactionDate) {
                showMessage('Semua kolom harus diisi dengan benar. Kuantitas harus lebih besar dari 0.', 'bg-yellow-100 border-yellow-400 text-yellow-700');
                submitButton.disabled = false;
                submitButton.textContent = 'Catat Stok Keluar';
                return;
            }

            // 1. Create a negative entry to represent stock reduction.
            const stockOutData = {
                // Must match the key used for stock in (index.html)
                name: name.toUpperCase(), 
                type: type,
                // CRITICAL: Save quantity as NEGATIVE to represent stock reduction
                quantity: -Math.abs(quantity), 
                date: transactionDate,
                timestamp: serverTimestamp(),
                userId: currentUserId,
                action: 'OUT_SALE' // Marker to indicate this is a sale/reduction entry
            };

            try {
                const stockCollectionRef = collection(db, getCollectionPath(appId));
                await addDoc(stockCollectionRef, stockOutData);

                showMessage(`Berhasil mencatat penjualan ${quantity} kg/unit ${name}. Stok telah dikurangi.`, 'bg-green-100 border-green-400 text-green-700');
                form.reset(); // Clear the form after success
            } catch (e) {
                console.error("Error adding document:", e);
                showMessage(`Gagal mencatat data: ${e.message}`, 'bg-red-100 border-red-400 text-red-700');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Catat Stok Keluar';
            }
        }


        // --- EVENT LISTENERS ---
        
        window.onload = function() {
            initApp();
            document.getElementById('stockOutForm').addEventListener('submit', handleStockOut);
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        };

    </script>
    
    <style>
        /* Menggunakan font Inter untuk tampilan modern */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Styling untuk input dan tombol */
        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem; /* rounded-lg */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        /* Definisi Styling Navigasi */
        .nav-item {
            padding: 8px 12px;
            color: #e5e7eb; /* Abu muda */
            font-weight: 500;
            transition: background-color 0.2s;
            border-radius: 8px;
            text-decoration: none;
            display: block;
            margin: 4px 0;
            text-align: center;
        }
        .nav-item:hover {
            background-color: #4338ca; /* Indigo 600 */
        }
        /* Kelas aktif untuk halaman ini */
        .nav-active {
            background-color: #312e81; /* Indigo 900, lebih gelap untuk menunjukkan halaman aktif */
            color: white;
            font-weight: 700;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    
    <!-- HEADER & NAVIGASI -->
    <header class="mb-8">
        <nav class="bg-indigo-700 p-3 md:p-4 rounded-xl shadow-lg flex flex-wrap justify-center space-x-2 md:space-x-6">
            <a href="index.html" class="nav-item">
                Beranda (Filter)
            </a>
            <a href="laporan_stok_pupuk.html" class="nav-item"> 
                Laporan Stok
            </a>
            <a href="penjualan_stok_keluar.html" class="nav-item nav-active">
                Stok Keluar
            </a>
        </nav>
    </header>

    <!-- KONTEN UTAMA -->
    <main class="max-w-xl mx-auto">
        
        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 mb-6">Catat Transaksi Stok Keluar (Penjualan)</h1>
        
        <p id="userIdDisplay" class="text-xs text-gray-500 mb-4"></p>

        <!-- Pesan/Notifikasi Box -->
        <div id="messageBox" class="opacity-0 scale-95 transition-all duration-300 mb-6" role="alert">
            <!-- Pesan akan muncul di sini -->
        </div>

        <!-- FORM PENCATATAN STOK KELUAR -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
            
            <form id="stockOutForm" class="space-y-4">
                
                <!-- Nama Pupuk -->
                <div>
                    <label for="fertilizerName" class="block text-sm font-medium text-gray-700 mb-1">Nama Pupuk (Contoh: UREA, NPK Padi)</label>
                    <input type="text" id="fertilizerName" name="fertilizerName" required placeholder="Masukkan nama pupuk yang dijual" class="input-field uppercase">
                </div>

                <!-- Tipe Pupuk -->
                <div>
                    <label for="fertilizerType" class="block text-sm font-medium text-gray-700 mb-1">Tipe Pupuk (Contoh: Bersubsidi, Non-Subsidi)</label>
                    <input type="text" id="fertilizerType" name="fertilizerType" required placeholder="Masukkan tipe/jenis pupuk" class="input-field">
                </div>
                
                <!-- Kuantitas Keluar -->
                <div>
                    <label for="quantityOut" class="block text-sm font-medium text-gray-700 mb-1">Kuantitas Penjualan (kg/unit)</label>
                    <input type="number" id="quantityOut" name="quantityOut" required min="1" step="0.01" placeholder="Masukkan jumlah yang dijual" class="input-field">
                </div>
                
                <!-- Tanggal Transaksi -->
                <div>
                    <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Transaksi</label>
                    <input type="date" id="transactionDate" name="transactionDate" required class="input-field">
                </div>

                <!-- Tombol Submit -->
                <button type="submit" id="submitButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg disabled:bg-red-400 disabled:cursor-not-allowed">
                    Catat Stok Keluar
                </button>
            </form>
        </div>

        <div class="mt-8 p-4 bg-red-50 border border-red-300 rounded-lg text-sm text-red-800">
            <p class="font-bold">Perhatian Penting:</p>
            <p>Data yang dicatat di sini akan tersimpan sebagai nilai **negatif** di database Anda. Ini adalah cara sistem menghitung stok **pengurangan** secara otomatis di halaman "Beranda" dan "Laporan Stok".</p>
        </div>

    </main>
</body>
</html>
