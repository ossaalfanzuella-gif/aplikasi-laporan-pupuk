<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Stok Pupuk - Laporan</title>
    
    <!-- Memuat Tailwind CSS untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Import Firebase SDK (Modul) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP & VARIABLES ---
        
        // Ensure global canvas variables are available
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUserId = null;
        
        // Firestore path: Using Public path for shared data
        // /artifacts/{appId}/public/data/fertilizer_stock
        const getCollectionPath = (appId) => `/artifacts/${appId}/public/data/fertilizer_stock`;

        // --- AUTHENTICATION AND INITIALIZATION ---
        
        async function initApp() {
            if (!firebaseConfig) {
                console.error("Firebase config is not available.");
                document.getElementById('reportList').innerHTML = '<tr><td colspan="3" class="p-4 text-red-600 font-bold text-center">Error: Konfigurasi Firebase tidak ditemukan.</td></tr>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set debug level
                setLogLevel('Debug');
                
                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID Pengguna Aktif: ${currentUserId}`;
                        console.log("User authenticated. UID:", currentUserId);
                        // Start listening to data after successful authentication
                        setupRealtimeListener(db, appId);
                        document.getElementById('loadingIndicator').classList.add('hidden');
                    } else {
                        currentUserId = crypto.randomUUID(); // Temporary anonymous ID
                        document.getElementById('userIdDisplay').textContent = `ID Pengguna Anonim: ${currentUserId}`;
                        console.error("Authentication failed, using temporary anonymous ID.");
                        document.getElementById('loadingIndicator').classList.add('hidden');
                    }
                });
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('reportList').innerHTML = '<tr><td colspan="3" class="p-4 text-red-600 font-bold text-center">Error Inisialisasi. Cek console log.</td></tr>';
            }
        }

        // --- FIREBASE DATA LISTENERS & AGGREGATION ---

        function setupRealtimeListener(db, appId) {
            const stockCollectionRef = collection(db, getCollectionPath(appId));
            const q = query(stockCollectionRef);

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                let allStockData = [];
                snapshot.forEach((doc) => {
                    allStockData.push({ id: doc.id, ...doc.data() });
                });
                console.log("New data received. Total entries:", allStockData.length);
                
                // Aggregate and render the data
                const aggregated = aggregateData(allStockData);
                renderReport(aggregated);
            }, (error) => {
                console.error("Failed to get data snapshot:", error);
                document.getElementById('reportList').innerHTML = '<tr><td colspan="3" class="p-4 text-red-600 font-bold text-center">Gagal memuat data stok.</td></tr>';
            });
        }
        
        /**
         * Aggregates fertilizer stock data by name.
         * @param {Array<Object>} data - The raw list of stock entries.
         * @returns {Array<Object>} The aggregated list.
         */
        function aggregateData(data) {
            const aggregatedMap = {};

            data.forEach(item => {
                const name = item.name || 'Tidak Bernama';
                const quantity = item.quantity && typeof item.quantity === 'number' ? item.quantity : 0;
                const type = item.type || '-';

                // Skip items without a name or valid quantity (e.g., deleted items or malformed data)
                if (!name || quantity <= 0) return; 

                if (aggregatedMap[name]) {
                    // Sum the quantity
                    aggregatedMap[name].totalQuantity += quantity;
                } else {
                    // Initialize new entry
                    aggregatedMap[name] = {
                        name: name,
                        type: type, // Take the type from the first entry encountered
                        totalQuantity: quantity
                    };
                }
            });

            // Convert map back to an array
            return Object.values(aggregatedMap);
        }
        
        // --- RENDERING LOGIC ---

        function renderReport(aggregatedData) {
            const reportListElement = document.getElementById('reportList');
            if (aggregatedData.length === 0) {
                reportListElement.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">Tidak ada data stok pupuk yang ditemukan.</td></tr>`;
                return;
            }

            // Sort data alphabetically by name
            aggregatedData.sort((a, b) => a.name.localeCompare(b.name));

            let html = '';
            aggregatedData.forEach(item => {
                html += `
                    <tr class="border-b hover:bg-green-50/50 transition duration-150">
                        <td class="p-3 text-sm font-medium text-gray-900">${item.name || '-'}</td>
                        <td class="p-3 text-sm text-gray-700">${item.type || '-'}</td>
                        <td class="p-3 text-sm font-bold text-right text-indigo-700 whitespace-nowrap">${item.totalQuantity ? item.totalQuantity.toLocaleString('id-ID') : 0} kg/unit</td>
                    </tr>
                `;
            });

            reportListElement.innerHTML = html;
        }

        // --- EVENT LISTENERS ---
        
        window.onload = function() {
            initApp();
        };

    </script>
    
    <style>
        /* Menggunakan font Inter untuk tampilan modern */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Styling tambahan untuk card */
        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* Definisi Styling Navigasi */
        .nav-item {
            padding: 8px 12px;
            color: #e5e7eb; /* Abu muda */
            font-weight: 500;
            transition: background-color 0.2s;
            border-radius: 8px;
            text-decoration: none;
            display: block;
            margin: 4px 0;
            text-align: center;
        }
        .nav-item:hover {
            background-color: #4338ca; /* Indigo 600 */
        }
        /* Kelas aktif untuk halaman ini */
        .nav-active {
            background-color: #312e81; /* Indigo 900, lebih gelap untuk menunjukkan halaman aktif */
            color: white;
            font-weight: 700;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    
    <!-- HEADER & NAVIGASI -->
    <header class="mb-8">
        <nav class="bg-indigo-700 p-3 md:p-4 rounded-xl shadow-lg flex flex-wrap justify-center space-x-2 md:space-x-6">
            <a href="index.html" class="nav-item">
                Beranda (Filter)
            </a>
            <a href="laporan_stok_pupuk.html" class="nav-item nav-active"> 
                Laporan Stok
            </a>
            <a href="penjualan_stok_keluar.html" class="nav-item">
                Stok Keluar
            </a>
        </nav>
    </header>

    <!-- KONTEN UTAMA -->
    <main class="max-w-4xl mx-auto">
        
        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 mb-6">Ringkasan Stok Pupuk Kumulatif</h1>
        
        <!-- Indikator Loading & Pesan -->
        <p id="userIdDisplay" class="text-xs text-gray-500 mb-4"></p>
        <div id="loadingIndicator" class="text-center p-4 bg-yellow-100 text-yellow-800 rounded-lg font-semibold transition duration-300">
            Memuat data dan menghitung ringkasan stok...
        </div>

        <!-- CARD LAPORAN HASIL -->
        <div class="card bg-white rounded-xl overflow-x-auto border border-gray-200 mt-6">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-700 mb-4">Total Stok Tersedia per Jenis</h2>
            </div>
            
            <!-- Tabel Data Laporan -->
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-green-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Pupuk</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipe Utama</th>
                        <th class="px-3 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Stok (kg/unit)</th>
                    </tr>
                </thead>
                <tbody id="reportList" class="bg-white divide-y divide-gray-200">
                    <!-- Data ringkasan akan dimasukkan di sini oleh JavaScript -->
                    <tr><td colspan="3" class="p-4 text-center text-gray-400">Menunggu data dimuat...</td></tr>
                </tbody>
            </table>
        </div>

    </main>
</body>
</html>
