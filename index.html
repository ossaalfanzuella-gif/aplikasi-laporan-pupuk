<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Stok Pupuk - Beranda</title>
    
    <!-- Memuat Tailwind CSS untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Import Firebase SDK (Modul) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc,
            serverTimestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP & VARIABLES ---
        
        // Memastikan variabel global canvas tersedia
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUserId = null;
        let allStockData = []; // Menyimpan semua data mentah dari Firestore
        
        // PATH Firestore: Menggunakan path Publik agar data dapat dibagi di antara pengguna.
        // /artifacts/{appId}/public/data/fertilizer_stock
        const getCollectionPath = (appId) => `/artifacts/${appId}/public/data/fertilizer_stock`;

        // --- AUTHENTICATION AND INITIALIZATION ---
        
        async function initApp() {
            if (!firebaseConfig) {
                console.error("Firebase config tidak tersedia. Tidak dapat menginisialisasi aplikasi.");
                document.getElementById('stockList').innerHTML = '<p class="text-red-600 font-bold">Error: Konfigurasi Firebase tidak ditemukan.</p>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Aktifkan log debug (Opsional, tapi bagus untuk pengembangan)
                setLogLevel('Debug');
                
                // Coba masuk dengan token khusus atau secara anonim
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Set listener untuk status autentikasi
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID Pengguna Aktif: ${currentUserId}`;
                        console.log("Pengguna terautentikasi. UID:", currentUserId);
                        // Mulai mendengarkan data setelah autentikasi berhasil
                        setupRealtimeListener(db, appId);
                        document.getElementById('loadingIndicator').classList.add('hidden');
                    } else {
                        currentUserId = crypto.randomUUID(); // Fallback ID sementara
                        document.getElementById('userIdDisplay').textContent = `ID Pengguna Anonim: ${currentUserId}`;
                        console.error("Gagal mengautentikasi, menggunakan ID anonim sementara.");
                        document.getElementById('loadingIndicator').classList.add('hidden');
                    }
                });
                
            } catch (error) {
                console.error("Kesalahan inisialisasi Firebase:", error);
                document.getElementById('stockList').innerHTML = '<p class="text-red-600 font-bold">Error Inisialisasi. Cek console log.</p>';
            }
        }

        // --- FIREBASE DATA LISTENERS & HELPERS ---

        function setupRealtimeListener(db, appId) {
            const stockCollectionRef = collection(db, getCollectionPath(appId));
            const q = query(stockCollectionRef);

            // Listener real-time
            onSnapshot(q, (snapshot) => {
                allStockData = [];
                snapshot.forEach((doc) => {
                    // Menyimpan ID dokumen dan data
                    allStockData.push({ id: doc.id, ...doc.data() });
                });
                console.log("Data baru diterima. Jumlah data:", allStockData.length);
                // Render data dengan filter saat ini
                applyFilters();
            }, (error) => {
                console.error("Gagal mendapatkan snapshot data:", error);
                document.getElementById('stockList').innerHTML = '<p class="text-red-600 font-bold">Gagal memuat data stok.</p>';
            });
        }
        
        // Fungsi untuk menambahkan data contoh ke Firestore
        window.addDummyData = async function() {
            if (!db) {
                alert('Aplikasi belum terinisialisasi.');
                return;
            }

            const dummyData = [
                { name: "UREA Kujang", type: "Nitrogen", quantity: 500, date: new Date(2025, 0, 15), addedBy: currentUserId, addedAt: serverTimestamp() },
                { name: "NPK Phonska", type: "Compound", quantity: 320, date: new Date(2025, 1, 28), addedBy: currentUserId, addedAt: serverTimestamp() },
                { name: "SP-36 Petro", type: "Phosphate", quantity: 180, date: new Date(2025, 2, 5), addedBy: currentUserId, addedAt: serverTimestamp() },
                { name: "KCL Mahkota", type: "Potassium", quantity: 450, date: new Date(2025, 3, 10), addedBy: currentUserId, addedAt: serverTimestamp() },
                { name: "ZA Petro", type: "Nitrogen", quantity: 210, date: new Date(2025, 4, 22), addedBy: currentUserId, addedAt: serverTimestamp() },
            ];

            const stockCollectionRef = collection(db, getCollectionPath(appId));
            
            try {
                let successCount = 0;
                for (const data of dummyData) {
                    await addDoc(stockCollectionRef, data);
                    successCount++;
                }
                document.getElementById('messageBox').textContent = `Berhasil menambahkan ${successCount} data contoh!`;
                document.getElementById('messageBox').classList.remove('hidden');
                setTimeout(() => document.getElementById('messageBox').classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error adding dummy data:", error);
                document.getElementById('messageBox').textContent = 'Gagal menambahkan data contoh.';
                document.getElementById('messageBox').classList.remove('hidden', 'bg-green-500');
                document.getElementById('messageBox').classList.add('bg-red-500');
            }
        };

        // --- FILTERING AND RENDERING LOGIC ---
        
        window.applyFilters = function() {
            const filterName = document.getElementById('filterName').value.toLowerCase();
            const filterType = document.getElementById('filterType').value.toLowerCase();
            const filterDateStart = document.getElementById('filterDateStart').value;
            const filterDateEnd = document.getElementById('filterDateEnd').value;
            
            let filteredData = allStockData.filter(item => {
                let passesName = true;
                let passesType = true;
                let passesDate = true;

                // Filter Nama
                if (filterName && !item.name.toLowerCase().includes(filterName)) {
                    passesName = false;
                }

                // Filter Tipe
                if (filterType && filterType !== 'semua' && !item.type.toLowerCase().includes(filterType)) {
                    passesType = false;
                }

                // Filter Tanggal (Asumsi 'date' di Firestore adalah objek Timestamp atau Date)
                if (filterDateStart || filterDateEnd) {
                    // Konversi Firestore Timestamp/Date object ke Date Javascript
                    const itemDate = item.date ? (item.date.toDate ? item.date.toDate() : new Date(item.date)) : null;
                    
                    if (itemDate) {
                        if (filterDateStart) {
                            const startDate = new Date(filterDateStart);
                            startDate.setHours(0, 0, 0, 0); // Mulai dari awal hari
                            if (itemDate < startDate) {
                                passesDate = false;
                            }
                        }

                        if (filterDateEnd) {
                            const endDate = new Date(filterDateEnd);
                            endDate.setHours(23, 59, 59, 999); // Sampai akhir hari
                            if (itemDate > endDate) {
                                passesDate = false;
                            }
                        }
                    } else {
                        // Abaikan item yang tidak punya tanggal jika filter tanggal diterapkan
                        passesDate = false;
                    }
                }
                
                return passesName && passesType && passesDate;
            });

            // Setelah data difilter, tampilkan
            renderData(filteredData);
        }

        function renderData(data) {
            const stockListElement = document.getElementById('stockList');
            if (data.length === 0) {
                stockListElement.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">Tidak ada data stok yang cocok dengan filter.</td></tr>`;
                return;
            }

            // Urutkan data berdasarkan tanggal (terbaru ke terlama) sebelum ditampilkan
            data.sort((a, b) => {
                const dateA = a.date ? (a.date.toDate ? a.date.toDate() : new Date(a.date)) : new Date(0);
                const dateB = b.date ? (b.date.toDate ? b.date.toDate() : new Date(b.date)) : new Date(0);
                return dateB - dateA; // Urutan descending (terbaru dulu)
            });

            let html = '';
            data.forEach(item => {
                // Format tanggal menjadi DD-MM-YYYY
                const dateObj = item.date ? (item.date.toDate ? item.date.toDate() : new Date(item.date)) : null;
                const formattedDate = dateObj ? dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';

                html += `
                    <tr class="border-b hover:bg-indigo-50/50 transition duration-150">
                        <td class="p-3 text-sm font-medium text-gray-900">${item.name || '-'}</td>
                        <td class="p-3 text-sm text-gray-700">${item.type || '-'}</td>
                        <td class="p-3 text-sm font-semibold text-right">${item.quantity ? item.quantity.toLocaleString('id-ID') : 0}</td>
                        <td class="p-3 text-sm text-gray-700 whitespace-nowrap">${formattedDate}</td>
                        <td class="p-3 text-sm text-center">
                            <!-- Tombol ini nanti dapat digunakan untuk aksi seperti Edit/Detail -->
                            <button class="text-indigo-600 hover:text-indigo-900 font-medium transition duration-150">Detail</button>
                        </td>
                    </tr>
                `;
            });

            stockListElement.innerHTML = html;
        }

        // --- EVENT LISTENERS ---
        
        // Memastikan inisialisasi dijalankan setelah DOM dimuat
        window.onload = function() {
            initApp();
            
            // Tambahkan event listener untuk semua elemen filter
            const filterElements = document.querySelectorAll('#filterForm input, #filterForm select');
            filterElements.forEach(el => el.addEventListener('change', applyFilters));
            // Juga tambahkan listener untuk input teks (saat mengetik)
            document.getElementById('filterName').addEventListener('input', applyFilters);
        };
        
        // Ekspos fungsi ke global scope untuk dipanggil dari HTML
        window.applyFilters = applyFilters;

    </script>
    
    <style>
        /* Menggunakan font Inter untuk tampilan modern */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Styling tambahan untuk card dan tabel */
        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* Definisi Styling Navigasi */
        .nav-item {
            padding: 8px 12px;
            color: #e5e7eb; /* Abu muda */
            font-weight: 500;
            transition: background-color 0.2s;
            border-radius: 8px;
            text-decoration: none;
            display: block;
            margin: 4px 0;
            text-align: center;
        }
        .nav-item:hover {
            background-color: #4338ca; /* Indigo 600 */
        }
        /* Kelas aktif untuk halaman ini */
        .nav-active {
            background-color: #312e81; /* Indigo 900, lebih gelap untuk menunjukkan halaman aktif */
            color: white;
            font-weight: 700;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    
    <!-- HEADER & NAVIGASI (Sesuai dengan instruksi sebelumnya) -->
    <header class="mb-8">
        <nav class="bg-indigo-700 p-3 md:p-4 rounded-xl shadow-lg flex flex-wrap justify-center space-x-2 md:space-x-6">
            <a href="index.html" class="nav-item nav-active">
                Beranda (Filter)
            </a>
            <a href="laporan_stok_pupuk.html" class="nav-item"> 
                Laporan Stok
            </a>
            <a href="penjualan_stok_keluar.html" class="nav-item">
                Stok Keluar
            </a>
        </nav>
    </header>

    <!-- KONTEN UTAMA -->
    <main class="max-w-7xl mx-auto">
        
        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 mb-6">Pencarian & Filter Stok Pupuk</h1>
        
        <!-- Indikator Loading & Pesan -->
        <p id="userIdDisplay" class="text-xs text-gray-500 mb-4"></p>
        <div id="loadingIndicator" class="text-center p-4 bg-yellow-100 text-yellow-800 rounded-lg font-semibold transition duration-300">
            Memuat data dan menginisialisasi sistem...
        </div>
        <div id="messageBox" class="hidden p-3 mb-4 bg-green-500 text-white font-medium rounded-lg transition duration-300"></div>

        <!-- CARD FILTER -->
        <div class="card bg-white p-6 rounded-xl mb-8 border border-gray-200" id="filterCard">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Pilih Filter Data</h2>
            <form id="filterForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                
                <!-- Filter Nama Pupuk -->
                <div>
                    <label for="filterName" class="block text-sm font-medium text-gray-700 mb-1">Nama Pupuk</label>
                    <input type="text" id="filterName" placeholder="Contoh: UREA" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <!-- Filter Tipe Pupuk -->
                <div>
                    <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Tipe Pupuk</label>
                    <select id="filterType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <option value="semua">Semua Tipe</option>
                        <option value="Nitrogen">Nitrogen</option>
                        <option value="Phosphate">Phosphate</option>
                        <option value="Potassium">Potassium</option>
                        <option value="Compound">Compound</option>
                        <option value="Organik">Organik</option>
                    </select>
                </div>

                <!-- Filter Tanggal Mulai -->
                <div>
                    <label for="filterDateStart" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai (Terima)</label>
                    <input type="date" id="filterDateStart" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <!-- Filter Tanggal Akhir -->
                <div>
                    <label for="filterDateEnd" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir (Terima)</label>
                    <input type="date" id="filterDateEnd" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
            </form>
            
            <!-- Tombol Aksi Tambahan -->
            <div class="mt-6 flex flex-wrap gap-3">
                <button onclick="addDummyData()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 transform hover:scale-[1.02]">
                    + Tambah Data Contoh
                </button>
                <button onclick="document.getElementById('filterForm').reset(); applyFilters();" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                    Reset Filter
                </button>
            </div>
        </div>
        
        <!-- CARD HASIL PENCARIAN -->
        <div class="card bg-white rounded-xl overflow-x-auto border border-gray-200">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-700 mb-4">Hasil Stok Pupuk</h2>
            </div>
            
            <!-- Tabel Data Stok -->
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Pupuk</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipe</th>
                        <th class="px-3 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Kuantitas (kg/unit)</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">Tanggal Masuk</th>
                        <th class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="stockList" class="bg-white divide-y divide-gray-200">
                    <!-- Data akan dimasukkan di sini oleh JavaScript -->
                </tbody>
            </table>
            
            <!-- Pesan jika tidak ada data -->
            <div id="noDataMessage" class="hidden text-center p-6 text-gray-500">
                Tidak ada data stok pupuk yang ditemukan.
            </div>
        </div>

    </main>
</body>
</html>
